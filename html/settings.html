<!DOCTYPE html>
<html>

<!-- HEAD -->
<head>
<meta charset="UTF-8">
<title>MOD Settings</title>

<link rel="apple-touch-icon" sizes="57x57" href="img/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="img/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="img/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="img/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="img/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="img/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="img/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="img/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="img/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="img/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
<link rel="manifest" href="img/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#111111">
<meta name="msapplication-TileImage" content="img/favicon/ms-icon-144x144.png">
<meta name="theme-color" content="#111111">

<link rel="stylesheet" type="text/css" href="css/fontello/css/fontello.css?v={{version}}"/>
<link rel="stylesheet" type="text/css" href="css/main.css?v={{version}}"/>
<link rel="stylesheet" type="text/css" href="css/dashboard.css?v={{version}}"/>
<link rel="stylesheet" type="text/css" href="css/fonts.css?v={{version}}"/>

<style type="text/css" media="screen">
    .settings-page {
        bottom: 0px;
    }
    .settings-page-content {
        background: #111;
        left: 20%;
        height: 92px;
        margin: 0;
        padding: 0;
        position: fixed;
        text-align: left;
        top: 45px;
        width: 50%;
    }
    .settings-page-content h1 {
        font-size: 2em;
        padding: 0em;
        max-height: 2em;
        display: block;
        margin: 0.5em 0.8em 0 0.8em;
        padding-bottom: 0.2em;
        color: white;
        white-space: nowrap;
        overflow: hidden;
    }
    .settings-page-content form {
        margin: 0 2em;
        color: #666;
    }
    .settings-page-content form label,
    .settings-page-content form p {
        color: #999;
    }
    .settings-page-content form label input {
        color: #555;
    }

    #bank-library #bank-list {
        bottom: 0px;
    }

    #bank-pedalboards-search #bank-pedalboards-result {
        background: none;
        top: 30px;
    }
    #bank-pedalboards-search #bank-pedalboards-result h2 {
        margin: 20px;
        width: 90px;
    }
    #bank-pedalboards-search #bank-pedalboards-result .form {
        min-height: 50px;
        color: #AAA;
    }
</style>

<script type="text/javascript" src="js/lib/jquery-1.9.1.min.js?v={{version}}"></script>
<script type="text/javascript" src="js/lib/jquery-ui-1.10.1.custom.min.js?v={{version}}"></script>
<script type="text/javascript" src="js/lib/jquery.ui.touch-punch.min.js?v={{version}}"></script>
<script type="text/javascript" src="js/lib/jquery.ba-resize.min.js?v={{version}}"></script>
<script type="text/javascript" src="js/lib/mustache.js?v={{version}}"></script>
<script type="text/javascript" src="js/lib/jquery.svg.js?v={{version}}"></script>
<script type="text/javascript" src="js/lib/sprintf-0.6.js?v={{version}}"></script>
<script type="text/javascript" src="js/lib/jquery.mousewheel.min.js?v={{version}}"></script>

<script type="text/javascript">
    {% autoescape None %}
    SITEURL = '{{cloud_url}}'
    VERSION = '{{version}}'
    var NOTIFICATIONS_ENABLED = true
    var PREFERENCES = {{preferences}}

    var INFO = {
        "hwname": "",
        "sysdate": "",
        "python": {},
        "uname": {}
    }

function bool2str(ok) {
    return ok ? "true" : "false"
}

function refresh_sysinfo() {
    $.ajax({
        url: '/system/info',
        method: 'GET',
        success: function (info) {
            INFO = info
            $("#info-system-unit").text(INFO.hwname)
            $("#info-system-date").text(INFO.sysdate)
            $("#info-kernel-machine").text(INFO.uname.machine)
            $("#info-kernel-release").text(INFO.uname.release)
            $("#info-kernel-version").text(INFO.uname.version)
        },
        cache: false,
        global: false,
        dataType: 'json'
    })
}

function refresh_sysprefs() {
    $.ajax({
        url: '/system/prefs',
        method: 'GET',
        success: function (resp) {
            console.log(resp)
            if (resp.bluetooth_name != null)
            {
                $("#prefs-bluetooth-custom").prop("checked", true)
                $("#prefs-bluetooth-name").prop("disabled", false).val(resp.bluetooth_name)
            }
            else
            {
                $("#prefs-bluetooth-custom").prop("checked", false)
                $("#prefs-bluetooth-name").prop("disabled", true)
            }

            $("#prefs-service-midiclock").prop("checked", resp.service_midiclock)
            $("#prefs-service-mixserver").prop("checked", resp.service_mixserver)
            $("#prefs-service-netmanager").prop("checked", resp.service_netmanager)
        },
        cache: false,
        global: false,
        dataType: 'json'
    })
}

function config_set(key, value) {
    $.ajax({
        url: '/config/set',
        method: 'POST',
        data: {
          key: key,
          value: value,
        },
        success: function (resp) {
            console.log("success", resp)
        },
        error: function (resp) {
            console.log("error", resp)
        },
        cache: false,
        dataType: 'json'
    })
}

function system_exechange(data) {
    $.ajax({
        url: '/system/exechange',
        method: 'POST',
        data: data,
        success: function (resp) {
            console.log("success", resp)
        },
        error: function (resp) {
            console.log("error", resp)
        },
        cache: false,
        dataType: 'json'
    })
}

function enable_service(name, enable) {
    console.log("enable_service", name, enable)
    system_exechange({
        'type'  : 'service',
        'name'  : name,
        'enable': enable ? 1 : 0,
    })
}

function run_custom_command(cmd) {
    console.log("run_custom_command", cmd)
    system_exechange({
        'type': 'command',
        'cmd' : cmd,
    })
}

function write_file_contents(path, content) {
    console.log("write_file_contents", path, content)
    system_exechange({
        'type'   : 'filewrite',
        'path'   : path,
        'content': content,
    })
}

$('document').ready(function() {
    var self = this

    var cached_cpuLoad
    var ws = new WebSocket("ws://" + window.location.host + "/websocket")

    ws.onclose = function (evt) {
    }

    ws.onmessage = function (evt) {
        var data = evt.data.split(" ")

        if (!data.length) {
            return
        }

        var cmd = data[0]

        if (cmd == "stats") {
            var cpuLoad = parseFloat(data[1])

            if (cpuLoad != cached_cpuLoad) {
                cached_cpuLoad = cpuLoad
                $("#info-dsp-load").text(""+cpuLoad.toString()+"%")
            }
            return
        }

        if (cmd == "ping") {
            ws.send("pong")
            return
        }

        if (cmd == "mem_load") {
            var value = parseFloat(data[1])
            /*
            $("#ram-bar").css("width", (100.0-value).toFixed().toString()+"%")
            $("#ram-bar-text").text("RAM "+value.toString()+"%")*/
            return
        }

//         console.log(data)
    }

    // ----------------------------------------------------------------------------------------------------------------

    $("#tab-basic").click(function () {
        // hide avanced
        $("#tab-advanced").removeClass("selected")
        $("#settings-page-advanced").hide()
        // hide dangerous
        $("#tab-dangerous").removeClass("selected")
        $("#settings-page-dangerous").hide()
        // show basic
        $("#tab-basic").addClass("selected")
        $("#settings-page-basic").show()
    })

    $("#tab-advanced").click(function () {
        // hide basic
        $("#tab-basic").removeClass("selected")
        $("#settings-page-basic").hide()
        // hide dangerous
        $("#tab-dangerous").removeClass("selected")
        $("#settings-page-dangerous").hide()
        // show advanced
        $("#tab-advanced").addClass("selected")
        $("#settings-page-advanced").show()
    })

    $("#tab-dangerous").click(function () {
        // hide basic
        $("#tab-basic").removeClass("selected")
        $("#settings-page-basic").hide()
        // hide advanced
        $("#tab-advanced").removeClass("selected")
        $("#settings-page-advanced").hide()
        // show dangerous
        $("#tab-dangerous").addClass("selected")
        $("#settings-page-dangerous").show()
    })

    // ----------------------------------------------------------------------------------------------------------------

    refresh_sysinfo()
    refresh_sysprefs()

    if (PREFERENCES['link-enabled-at-boot'] == "true") {
        $("#transport-rolling-at-boot").prop("checked", true)
    }
    if (PREFERENCES['transport-rolling-at-boot'] == "true") {
        $("#prefs-prefs-autostart-playback").prop("checked", true)
    }
    if (PREFERENCES['tuner-mutes-outputs'] != "false") {
        $("#prefs-prefs-muted-tuner").prop("checked", true)
    }

    if (PREFERENCES['dev-mode'] == "on") {
        $("#prefs-ui-developer-mode").prop("checked", true)
    }
    if (PREFERENCES['show-unstable-plugins'] == "true") {
        $("#prefs-ui-unstable-plugins").prop("checked", true)
    }

    // ----------------------------------------------------------------------------------------------------------------
    // --- Personal :: Bluetooth custom name

    this.last_bluetooth_timeout = null
    this.set_bluetooth_name = function() {

        if (self.last_bluetooth_timeout != null) {
            clearTimeout(self.last_bluetooth_timeout)
            self.last_bluetooth_timeout = null
        }

        var name = $("#prefs-bluetooth-name").val()
        write_file_contents("bluetooth/name", name)
    }

    $("#prefs-bluetooth-custom").click(function (e) {
        var elem_btname = $("#prefs-bluetooth-name")

        if ($(this).prop("checked")) {
            // Give it a default name if one was not set before
            if (! elem_btname.val()) {
                elem_btname.val(INFO.hwname)
            }
            elem_btname.prop("disabled", false)

            // Set name
            self.set_bluetooth_name()

        } else {
            // disable text input
            elem_btname.prop("disabled", true)

            // clear name
            // TODO
        }
    })

    $("#prefs-bluetooth-name")
    .keydown(function (e) {
        if (e.keyCode == 13) {
            // detect enter
            self.set_bluetooth_name()
            return false
        } else if (e.keyCode == 8 || e.keyCode == 46) {
            if (self.last_bluetooth_timeout != null) {
                clearTimeout(self.last_bluetooth_timeout)
            }
            // detect delete and backspace
            self.last_bluetooth_timeout = setTimeout(function () {
                self.set_bluetooth_name()
            }, 400)
        }
    })
    .keypress(function (e) { // keypress won't detect delete and backspace but will only allow inputable keys
        if (e.which == 13) {
            return
        }
        if (self.last_bluetooth_timeout != null) {
            clearTimeout(self.last_bluetooth_timeout)
        }
        self.last_bluetooth_timeout = setTimeout(function () {
            self.set_bluetooth_name()
        }, 400)
    })

    // ----------------------------------------------------------------------------------------------------------------
    // --- Preferences

    $("#prefs-prefs-autostart-playback").click(function (e) {
        config_set("transport-rolling-at-boot", bool2str($(this).prop("checked")))
    })

    $("#prefs-prefs-autostart-link").click(function (e) {
        config_set("link-enabled-at-boot", bool2str($(this).prop("checked")))
    })

    $("#prefs-prefs-muted-tuner").click(function (e) {
        config_set("tuner-mutes-outputs", bool2str($(this).prop("checked")))
    })

    // ----------------------------------------------------------------------------------------------------------------
    // --- Maintenance & Backup

    // ----------------------------------------------------------------------------------------------------------------
    // --- Services

    $("#prefs-service-midiclock").click(function (e) {
        enable_service("midiclock", $(this).prop("checked"))
    })

    $("#prefs-service-mixserver").click(function () {
        enable_service("mixserver", $(this).prop("checked"))
    })

    $("#prefs-service-netmanager").click(function () {
        enable_service("netmanager", $(this).prop("checked"))
    })

    // ----------------------------------------------------------------------------------------------------------------
    // --- User Interface

    $("#prefs-ui-developer-mode").click(function (e) {
        config_set("dev-mode", $(this).prop("checked") ? "on" : "off")
    })

    $("#prefs-ui-unstable-plugins").click(function (e) {
        var checked = $(this).prop("checked")
        if (checked && !confirm("TODO: note here about unstable")) {
            $(this).prop("checked", false)
            return
        }
        config_set("show-unstable-plugins", bool2str(checked))
    })

    // ----------------------------------------------------------------------------------------------------------------
    // --- Boot?

    $("#button-action-reboot").click(function () {
        run_custom_command("reboot")
    })

    $("#button-action-restore").click(function () {
        run_custom_command("restore")
    })

    // ----------------------------------------------------------------------------------------------------------------

    // start code for ajax loading bar

    NProgress.configure({
      template: '<div class="bar" role="bar"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div>'
    });

    $(document)
    .ajaxStart(function(data) {
        NProgress.start();
    })
    .ajaxComplete(function() {
        NProgress.done();
    });

    // end code for ajax loading bar
})
</script>

<script type="text/javascript" src="js/common.js?v={{version}}"></script>
<script type="text/javascript" src="js/file_transfer.js?v={{version}}"></script>
<script type="text/javascript" src="js/window.js?v={{version}}"></script>
<script type="text/javascript" src="js/modgui.js?v={{version}}"></script>
<script type="text/javascript" src="js/notification.js?v={{version}}"></script>
<script type="text/javascript" src="js/nprogress.js?v={{version}}"></script>
<script type="text/javascript" src="js/networkstatus.js?v={{version}}"></script>

</head>
<!-- END HEAD -->

<!-- BODY -->
<body class="mod-dark">

<!-- WRAPPER -->
<div id="wrapper">

    <!-- BANKS|SETTINGS -->
    <div id="bank-library">
        <div class="box clearfix">
            <header>
                <h1 class="bottom top">MOD Settings</h1>
                <!--
                <div class="form-group">
                    <input id="searchPedalboard" class="form-control" maxlength="20" placeholder="Filter by keyword(s)" type="search"/>
                </div>
                <a style="display:inline-block;float:right;color:#AAA;font-size:1.1em;margin-right:30px;"
                   href="http://pedalboards.moddevices.com/" target="_blank">
                    <img style="width: 1.2em; height: 1.2em; opacity: 0.6; vertical-align: middle;" src="img/icons/25/language.png" alt=""/>
                    <span style="vertical-align: middle;">Browse Online Pedalboards</span>
                </a>
                -->
            </header>
            <div class="pedalboards clearfix js-pedalboards"></div>
        </div>

        <!-- BANK|SETTINGS-LIST -->
        <div id="bank-list">
            <div id="tab-basic" class="add-bank selected">(ico) Basic</div>
            <div id="tab-advanced" class="add-bank">(ico) Advanced</div>
            <!--<div id="tab-dangerous" class="add-bank">(ico) Dangerous</div>-->
        </div>
        <!-- END BANK|SETTINGS-LIST -->

        <!-- SETTINGS PAGE (BASIC) -->
        <div class="settings-page" id="settings-page-basic">
            <div class="settings-page-content">
                <h1>Personal</h1>
                <form class="form">
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-bluetooth-custom">
                            Use custom Bluetooth device name: &nbsp;
                        </input>
                        <input type="text" value="" id="prefs-bluetooth-name" disabled></input>
                    </label>
                </form>

                <h1>Preferences</h1>
                <form class="form">
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-prefs-autostart-playback">
                            Always start with playback/transport rolling
                        </input>
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-prefs-autostart-link">
                            Always start with Link support enabled
                        </input>
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-prefs-muted-tuner">
                            Mute audio outputs when Tuner is enabled
                        </input>
                    </label>
                </form>

                <!--
                <h1>Maintenance &amp; Backup</h1>
                <form class="form">
                    <label>
                        <input type="button" value="Export user settings..."></input>
                        <input type="button" value="Import user settings..."></input>
                    </label>
                </form>
                -->

                <h1>Services</h1>
                <form class="form">
                    <p>
                        Note: Each additional service you enable consumes a small amount of CPU.<br/>
                        Only enable services that you absolutely need.
                    </p>
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-service-netmanager"> JACK Net Manager (EXPERIMENTAL)</input>
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-service-midiclock"> MIDI Clock Output</input>
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-service-mixserver"> Remote Mix Server</input>
                    </label>
                </form>
            </div>
        </div>
        <!-- END SETTINGS PAGE (BASIC) -->

        <!-- SETTINGS PAGE (ADVANCED) -->
        <div class="settings-page mod-hidden" id="settings-page-advanced">
            <div class="settings-page-content">
                <h1>User Interface</h1>
                <form class="form">
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-ui-developer-mode">
                            Developer Mode
                        </input>
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-ui-unstable-plugins">
                            Show unstable in Plugin Store
                        </input>
                    </label>
                </form>

                <h1>Boot?</h1>
                <form class="form">
                    <label>
                        <input type="button" id="button-action-reboot" value="Reboot MOD"></input>
                        <input type="button" id="button-action-restore" value="Start recovery mode"></input>
                    </label>
                </form>
            </div>
        </div>
        <!-- SETTINGS PAGE (ADVANCED) -->

        <!-- SETTINGS PAGE (DANGEROUS) -->
        <div class="settings-page mod-hidden" id="settings-page-dangerous">
            <div class="settings-page-content">
                <h1>Cleanup</h1>
                <form class="form">
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-delete-banks"> Banks</input>
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-delete-pedalboards"> Pedalboards</input>
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" autocomplete="off" id="prefs-delete-plugins"> Plugins</input>
                    </label>
                    <br>
                    <label>
                        <input type="button" id="button-action-delete" value="Delete"></input>
                    </label>
                </form>
            </div>
        </div>
        <!-- SETTINGS PAGE (DANGEROUS) -->

        <!-- BANK-PEDALBOARDS-SEARCH|SYSTEM-INFORMATION -->
        <div id="bank-pedalboards-search"><div class="box">
            <!-- FORM HORIZONTAL -->
            <div class="filter clearfix"><div class="clearfix">
                <div class="form-group">
                    <label>System Information</label>
                </div>
            </div></div>
            <!-- END FORM-HORIZONTAL -->

            <!-- BANK-PEDALBOARDS-RESULT|SYSTEM-INFORMATION -->
            <div id="bank-pedalboards-result">
                <hr style="border:1px solid #444;"/>

                <h2>Audio</h2>
                <form class="form">
                    <b>Buffer Size:</b> {{bufferSize}} frames<br/>
                    <b>Sample Rate:</b> {{sampleRate}} Hz<br/>
                    <b>DSP Load:</b> <span id="info-dsp-load">--.- %</span><br/>
                </form>

                <hr style="border:1px solid #333;"/>

                <h2>System</h2>
                <form class="form">
                    <b>Unit:</b> <span id="info-system-unit">---</span><br/>
                    <b>Build Date:</b> <span id="info-system-date">---</span><br/>
                    <b>OS Version:</b> {{version}}<br/>
                </form>

                <hr style="border:1px solid #333;"/>

                <h2>Kernel</h2>
                <form class="form">
                    <b>Machine:</b> <span id="info-kernel-machine">---</span><br/>
                    <b>Release:</b> <span id="info-kernel-release">---</span><br/>
                    <b>Version:</b> <span id="info-kernel-version">---</span><br/>
                </form>

                <hr style="border:1px solid #444;"/>
            </div>
            <!-- END BANK-PEDALBOARDS-RESULT|SYSTEM-INFORMATION -->

        </div></div>
        <!-- END BANK-PEDALBOARDS-SEARCH|SYSTEM-INFORMATION -->

    </div>
    <!-- END BANKS|SETTINGS -->

<!-- END WRAPPER -->
</div>

</body>
<!-- END BODY -->

</html>
